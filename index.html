<!DOCTYPE html>
<html>
<head>
    <title>Rovio mobile</title>
    <script type="text/javascript" src="app/javascript/prototype.js"></script>
    <script type="text/javascript" src="app/javascript/scriptaculous.js"></script>
    <script type="text/javascript" src="app/javascript/rovio.js"></script>
    <script type="text/javascript" src="app/javascript/screenfull.js"></script>
    <script type="text/javascript" src="app/javascript/keyboard.js"></script>
    <script type="text/javascript" src="app/javascript/accelerometer.js"></script>
    <script type="text/javascript" src="app/javascript/camera.js"></script>
    <script type="text/javascript">
    // <![CDATA[
        var hHeight, bHeight, slide, direction1='', direction2='', lastDirection = 'stop_moving', last_cam_pos = 'down';
		var speed=0.90, captureY = 0, accelerometer_on = false, savingFoto = false;
        
        function setBgPos(v) {
            var off = v * hHeight;
            var pos = -bHeight + (v * bHeight);
            //$('slider').setStyle({backgroundPosition: 0 Math.round(pos - off) + 'px'});
			//$('debug').innerHTML = v;
        }
        
        function setSlideOutput(v) {
            $('percent').update(100-Math.round(v * 100) + '%');
            if (100-Math.round(v * 100) == 0){
            	stopMoving();
            }
            else{
				speed = v*10 + 1;
				console.log(v);
				//$(debug).innerHTML = v;
			}
        }
		
        Event.observe(window, 'load', function() {		
			Event.observe('camera_container', 'DOMMouseScroll', wheel); // mozilla
			Event.observe('camera_container', 'mousewheel', wheel);	// IE/Opera
			
//			window.addEventListener('deviceorientation', function(e) {
//				logAction(e.webkitCompassHeading);
//			}, false);

		    window.ondevicemotion = function(event) {  
				var accelerationX = event.accelerationIncludingGravity.x;  
				var accelerationY = event.accelerationIncludingGravity.y;  
				var accelerationZ = event.accelerationIncludingGravity.z; 
				processAccelerometer(accelerationX, accelerationY, accelerationZ);
			}  
			
			screenfull.onchange = function() {
				if(screenfull.isFullscreen==false) //&&(EnteringFullscreen==false)) 
				{
					FullScreenSlide.setValue(0.1);
				}
			}
			
			screenfull.onerror = function() {
				alert("Fullscreen API error");
			}
            hWidth = $('slider-handle').getHeight();
            bWidth = $('slider-bar').getHeight();
            slide = new Control.Slider('slider-handle', 'slider-bar', {
				axis: 'vertical',
                sliderValue: 0.90,
				values: [0,0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,1],
                onSlide: 
                    function(v) {
                        setBgPos(v);
                        setSlideOutput(v);
                    },
                onChange:
                    function(v) {
                        setBgPos(v);
                        setSlideOutput(v);
                    }
            });
            setBgPos(slide.value);
            setSlideOutput(slide.value);
			
            slide2 = new Control.Slider('camvid-slider-handle', 'camvid-slider-bar', {
				axis: 'horizontal',
                sliderValue: 1,
				values: [0.1,0.9],
                onSlide: 
                    function(v) {
                    },
                onChange:
                    function(v) {
                    	CaptureONForced('camvid-capture'); //Grazinamas capture mygtukas i pradine padeti, nutraukiamas filmavimas
                    }
            });

            FullScreenSlide = new Control.Slider('fullscreen-slider-handle', 'fullscreen-slider-bar', {
				axis: 'horizontal',
                sliderValue: 0.1,
				values: [0.1,0.9],
                onSlide: 
                    function(v) {
                    },
                onChange:
                    function(v) {
						if(v==0.9){ accelerometer_on=true; setAllButtonsUp('forward', 'forward', 'strifeleft', 'left', 'striferight', 'right', 'backward', 'backward', 'rotate_left', 'left', 'rotate_right', 'right');}
						if(v==0.1){ accelerometer_on=false; setAllButtonsUp('forward', 'forward', 'strifeleft', 'left', 'striferight', 'right', 'backward', 'backward', 'rotate_left', 'left', 'rotate_right', 'right');}
                    }
            });
			
        });
		
		function logAction(Action) {
			//$('debug').update(Action);
		}
		
		// mouse wheel code from http://adomas.org/javascript-mouse-wheel/
		function handle(delta) {		
			slide.setValueBy(-delta);
		}

			/** Event handler for mouse wheel event. */
		function wheel(event){
			var delta = 0;
			if (!event) /* For IE. */
				event = window.event;
			if (event.wheelDelta) { /* IE/Opera. */
				delta = event.wheelDelta/1200;
				/** In Opera 9, delta differs in sign as compared to IE. */
				if (window.opera)
					delta = -delta;
			} else if (event.detail) { /** Mozilla case. */
				/** In Mozilla, sign of delta is different than in IE.
				* Also, delta is multiple of 3.
				*/
				delta = -event.detail/21;
			}
		
			/** If delta is nonzero, handle it.
			* Basically, delta is now positive if wheel was scrolled up,
			* and negative, if wheel was scrolled down.
			*/
			if (delta)
				handle(delta);
		
			/** Prevent default actions caused by mouse wheel.
			* That might be ugly, but we handle scrolls somehow
			* anyway, so don't bother here..
			*/
			if (event.preventDefault)
				event.preventDefault();
				
			event.returnValue = false;
		}
		
    // ]]>
    </script>
	<!-- TODO : Style sheets code -->
	<link rel="stylesheet" href="app/stylesheets/Main.css" type="text/css">
	<link rel="stylesheet" href="app/stylesheets/slider.css" type="text/css">

</head>

<!-- <body onload="init(); resizeCamera();" onResize="resizeCamera();"> -->
<body onload="init();resizeCamera();" onunload="closeStream();" onResize="resizeCamera();">
<a id="fake_link" href="" onclick="return false"></a>
<div id="camera_container">
</div>
<div id="camera_container2" ontouchmove="event.preventDefault();" style="background-size: 100% 100%;" onmouseup="setAllButtonsUp('forward', 'forward', 'strifeleft', 'left', 'striferight', 'right', 'backward', 'backward', 'rotate_left', 'left', 'rotate_right', 'right');">
	<div id="slider">
		<div id="slider-bar">
			<div id="slider-handle"><p id="percent"></p></div>
		</div>
	</div>
	<div id="head_position">
		<div id="position1" ontouchstart="event.preventDefault(); setHeadPosition('down');" onmousedown="setHeadPosition('down');"></div>
		<div id="position2" ontouchstart="event.preventDefault(); setHeadPosition('mid');" onmousedown="setHeadPosition('mid');"></div>
		<div id="position3" ontouchstart="event.preventDefault(); setHeadPosition('up');" onmousedown="setHeadPosition('up');"></div>
	</div>
	<div id="fullscreen-slider">
		<div id="fullscreen-slider-bar">
			<div id="fullscreen-slider-handle"><p></p></div>
		</div>
	</div>
	<div id="camvid-slider">
		<div id="camvid-slider-bar">
			<div id="camvid-slider-handle"><p></p></div>
		</div>
		<div id="camvid-capture" ontouchstart="event.preventDefault(); CaptureON('camvid-capture', 0);" ontouchend="event.preventDefault(); CaptureON('camvid-capture', 1);"
		 onmousedown="CaptureON('camvid-capture', 0);" onmouseup="CaptureON('camvid-capture', 1);"></div>
	</div>
	<div id="controller">
		<div id="forward" 
			ontouchstart="event.preventDefault(); setButtonDown('forward', 'forward', 0, 36);" ontouchend="event.preventDefault(); setButtonUp('forward', 'forward');" 
			onmousedown="setButtonDown('forward', 'forward', 0, 36);" onmouseup="setButtonUp('forward', 'forward');"></div>
		<div id="strifeleft" 
			ontouchstart="event.preventDefault(); setButtonDown('strifeleft', 'left', 36, 0);" ontouchend="event.preventDefault(); setButtonUp('strifeleft', 'left');" 
			onmousedown="setButtonDown('strifeleft', 'left', 36, 0);" onmouseup="setButtonUp('strifeleft', 'left');"></div>
		<div id="striferight" 
			ontouchstart="event.preventDefault(); setButtonDown('striferight', 'right', 36, 0);" ontouchend="event.preventDefault(); setButtonUp('striferight', 'right');" 
			onmousedown="setButtonDown('striferight', 'right', 36, 0);" onmouseup="setButtonUp('striferight', 'right');"></div>
		<div id="backward" 
			ontouchstart="event.preventDefault(); setButtonDown('backward', 'backward', 0, 36);" ontouchend="event.preventDefault(); setButtonUp('backward', 'backward');" 
			onmousedown="setButtonDown('backward', 'backward', 0, 36);" onmouseup="setButtonUp('backward', 'backward');"></div>
        <div id="joystick_box">
            <div id="joystick"></div>
        </div>	
	</div>
	<div id="rotate_buttons">
		<div id="rotate_left" 
			ontouchstart="event.preventDefault(); setButtonDown2('rotate_left', 'left', 0, 62);" ontouchend="event.preventDefault(); setButtonUp2('rotate_left', 'left', 0, 0);" 
			onmousedown="setButtonDown2('rotate_left', 'left', 0, 62);" onmouseup="setButtonUp2('rotate_left', 'left', 0, 0);"></div>
		<div id="rotate_right" 
			ontouchstart="event.preventDefault(); setButtonDown2('rotate_right', 'right', 0, 62);" ontouchend="event.preventDefault(); setButtonUp2('rotate_right', 'right', 0, 0);" 
			onmousedown="setButtonDown2('rotate_right', 'right', 0, 62);" onmouseup="setButtonUp2('rotate_right', 'right', 0, 0);"></div>
	</div>
	<div id="foto_container">
		<img id="fotoimage" width="100%" height="100%" src="images/empty.png" />
	</div>
</div>

<div id="hiddenFrame" style="display:none;"><iframe id="fakedframe" name="fakedframe" style="display:none;" src="" /></div>

</body>
</html>
